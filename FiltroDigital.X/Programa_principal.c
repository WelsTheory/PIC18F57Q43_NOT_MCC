/*
 * File:   Programa_principal.c
 * Author: Wels
 *
 * Created on 10 de agosto de 2021, 07:51 PM
 */

#include <xc.h>
#include <stdio.h> // Librería
#include "Configuracion.h"
#include "UART_Libreria.h"
#include "ADC_Libreria.h"
#include "Interrupcion_Libreria.h"
#include "Timer0_Libreria.h"

float temp;

uint16_t Muestra[1201] = {1229,1605,917,1293,1669,981,1357,1732,1044,1420,1795,1106,1482,1857,1167,1542,1916,1226,1600,1974,1283,1656,2029,1338,1710,2082,1389,1760,2131,1438,1808,2177,1482,1851,2220,1524,1891,2258,1561,1927,2292,1594,1958,2322,1622,1985,2348,1646,2007,2368,1665,2025,2384,1679,2037,2395,1688,2045,2401,1693,2047,2402,1692,2045,2398,1686,2037,2388,1675,2025,2374,1659,2007,2355,1638,1985,2331,1613,1958,2303,1583,1927,2270,1549,1891,2233,1510,1851,2192,1468,1808,2147,1422,1760,2099,1372,1710,2047,1320,1656,1993,1265,1600,1936,1207,1542,1877,1147,1482,1816,1086,1420,1753,1023,1357,1690,959,1293,1626,895,1228,1562,831,1164,1498,767,1100,1434,704,1037,1371,641,975,1310,580,915,1250,521,857,1192,464,801,1137,410,747,1085,358,697,1035,310,649,989,265,606,947,224,566,908,187,530,874,154,499,844,126,472,819,102,450,798,83,432,782,69,420,771,59,412,765,55,409,764,56,412,769,62,420,778,73,432,792,89,450,811,109,472,835,135,499,863,165,530,896,199,566,933,237,606,975,280,649,1019,326,697,1068,375,747,1119,428,801,1174,483,857,1231,541,915,1290,600,975,1351,662,1037,1413,725,1100,1476,788,1164,1540,852,1228,1605,917,1293,1669,981,1357,1732,1044,1420,1795,1106,1482,1857,1167,1542,1916,1226,1600,1974,1283,1656,2029,1338,1710,2082,1389,1760,2131,1438,1808,2177,1482,1851,2220,1524,1891,2258,1561,1927,2292,1594,1958,2322,1622,1985,2348,1646,2007,2368,1665,2025,2384,1679,2037,2395,1688,2045,2401,1693,2048,2402,1692,2045,2398,1686,2037,2388,1675,2025,2374,1659,2007,2355,1638,1985,2331,1613,1958,2303,1583,1927,2270,1549,1891,2233,1510,1851,2192,1468,1808,2147,1422,1760,2099,1372,1710,2047,1320,1656,1993,1265,1600,1936,1207,1542,1877,1147,1482,1816,1086,1420,1753,1023,1357,1690,959,1293,1626,895,1228,1562,831,1164,1498,767,1100,1434,704,1037,1371,641,975,1310,580,915,1250,521,857,1192,464,801,1137,410,747,1085,358,697,1035,310,649,989,265,606,947,224,566,908,187,530,874,154,499,844,126,472,819,102,450,798,83,432,782,69,420,771,59,412,765,55,409,764,56,412,769,62,420,778,73,432,792,89,450,811,109,472,835,135,499,863,165,530,896,199,566,933,237,606,975,280,649,1019,326,697,1068,375,747,1119,428,801,1174,483,857,1231,541,915,1290,600,975,1351,662,1037,1413,725,1100,1476,788,1164,1540,852,1228,1605,917,1293,1669,981,1357,1732,1044,1420,1795,1106,1482,1857,1167,1542,1916,1226,1600,1974,1283,1656,2029,1338,1710,2082,1389,1760,2131,1438,1808,2177,1482,1851,2220,1524,1891,2258,1561,1927,2292,1594,1958,2322,1622,1985,2348,1646,2007,2368,1665,2025,2384,1679,2037,2395,1688,2045,2401,1693,2047,2402,1692,2045,2398,1686,2037,2388,1675,2025,2374,1659,2007,2355,1638,1985,2331,1613,1958,2303,1583,1927,2270,1549,1891,2233,1510,1851,2192,1468,1808,2147,1422,1760,2099,1372,1710,2047,1320,1656,1993,1265,1600,1936,1207,1542,1877,1147,1482,1816,1086,1420,1753,1023,1357,1690,959,1293,1626,895,1229,1562,831,1164,1498,767,1100,1434,704,1037,1371,641,975,1310,580,915,1250,521,857,1192,464,801,1137,410,747,1085,358,697,1035,310,649,989,265,606,947,224,566,908,187,530,874,154,499,844,126,472,819,102,450,798,83,432,782,69,420,771,59,412,765,55,410,764,56,412,769,62,420,778,73,432,792,89,450,811,109,472,835,135,499,863,165,530,896,199,566,933,237,606,975,280,649,1019,326,697,1068,375,747,1119,428,801,1174,483,857,1231,541,915,1290,600,975,1351,662,1037,1413,725,1100,1476,788,1164,1540,852,1228,1605,917,1293,1669,981,1357,1732,1044,1420,1795,1106,1482,1857,1167,1542,1916,1226,1600,1974,1283,1656,2029,1338,1710,2082,1389,1760,2131,1438,1808,2177,1482,1851,2220,1524,1891,2258,1561,1927,2292,1594,1958,2322,1622,1985,2348,1646,2007,2368,1665,2025,2384,1679,2037,2395,1688,2045,2401,1693,2047,2402,1692,2045,2398,1686,2037,2388,1675,2025,2374,1659,2007,2355,1638,1985,2331,1613,1958,2303,1583,1927,2270,1549,1891,2233,1510,1851,2192,1468,1808,2147,1422,1760,2099,1372,1710,2047,1320,1656,1993,1265,1600,1936,1207,1542,1877,1147,1482,1816,1086,1420,1753,1023,1357,1690,959,1293,1626,895,1228,1562,831,1164,1498,767,1100,1434,704,1037,1371,641,975,1310,580,915,1250,521,857,1192,464,801,1137,410,747,1085,358,697,1035,310,649,989,265,606,947,224,566,908,187,530,874,154,499,844,126,472,819,102,450,798,83,432,782,69,420,771,59,412,765,55,409,764,56,412,769,62,420,778,73,432,792,89,450,811,109,472,835,135,499,863,165,530,896,199,566,933,237,606,975,280,649,1019,326,697,1068,375,747,1119,428,801,1174,483,857,1231,541,915,1290,600,975,1351,662,1037,1413,725,1100,1476,788,1164,1540,852,1228,1605,917,1293,1669,981,1357,1732,1044,1420,1795,1106,1482,1857,1167,1542,1916,1226,1600,1974,1283,1656,2029,1338,1710,2082,1389,1760,2131,1438,1808,2177,1482,1851,2220,1524,1891,2258,1561,1927,2292,1594,1958,2322,1622,1985,2348,1646,2007,2368,1665,2025,2384,1679,2037,2395,1688,2045,2401,1693,2047,2402,1692,2045,2398,1686,2037,2388,1675,2025,2374,1659,2007,2355,1638,1985,2331,1613,1958,2303,1583,1927,2270,1549,1891,2233,1510,1851,2192,1468,1808,2147,1422,1760,2099,1372,1710,2047,1320,1656,1993,1265,1600,1936,1207,1542,1877,1147,1482,1816,1086,1420,1753,1023,1357,1690,959,1293,1626,895,1228,1562,831,1164,1498,767,1100,1434,704,1037,1371,641,975,1310,580,915,1250,521,857,1192,464,801,1137,410,747,1085,358,697,1035,310,649,989,265,606,947,224,566,908,187,530,874,154,499,844,126,472,819,102,450,798,83,432,782,69,420,771,59,412,765,55,409,764,56,412,769,62,420,778,73,432,792,89,450,811,109,472,835,135,499,863,165,530,896,199,566,933,237,606,975,280,649,1019,326,697,1068,375,747,1119,428,801,1174,483,857,1231,541,915,1290,600,975,1351,662,1037,1413,725,1100,1476,788,1164,1540,852,1229};

extern volatile uint16_t resultado[ARRAY_SAMPLE];// 16 bits
extern volatile uint16_t muestras;

        // resultado -> 16 bits
        // uart -> 8 bits 
        // 8bits 8bits
void Envio_Muestras(void){
    for(uint16_t i = 0; i < ARRAY_SAMPLE; i++){
        UART_Tx(START_Streaming);// 03
        UART_Tx(resultado[i]& 0x00FF); 
        UART_Tx((resultado[i]& 0xFF00)>>8);
        UART_Tx(END_Streaming); // FE
        for(uint16_t k = 0; k<10000;k++);
    }
}

void signal(void){
    for(uint16_t i = 0; i < 1201; i++){
            X.n[1] = X.n[0];// 0   5 
            X.n[0] = Muestra[i];// 5  25
            temp = Coef_a0*X.n[0] + Coef_a1*X.n[1] + Coef_b1*Y.n[1];
            Y.n[1] = Y.n[0];
            Y.n[0] = (uint16_t)temp;
            UART_Tx(START_Streaming);// 03
            UART_Tx(Y.n[0]& 0x00FF); 
            UART_Tx((Y.n[0]& 0xFF00)>>8);
            UART_Tx(END_Streaming); // FE
            __delay_ms(1);
        }   
//        for(uint16_t i = 0; i < 1201; i++){
//            UART_Tx(START_Streaming);// 03
//            UART_Tx(Muestra[i]& 0x00FF); 
//            UART_Tx((Muestra[i]& 0xFF00)>>8);
//            UART_Tx(END_Streaming); // FE
//            __delay_ms(1);
//        }
}

void main(void) {
    Clock_Init();
    //PIN RF3
    TRISFbits.TRISF3 = 0; // salida
    ANSELFbits.ANSELF3 = 0; // Digital
    WPUFbits.WPUF3 = 0; // deshabilitado pull up
    INLVLFbits.INLVLF3 = 0; // TTL
    SLRCONFbits.SLRF3 = 1; // Limitado
    ODCONFbits.ODCF3 = 0; // Push Pull  
    X.n[0] = 0;
    X.n[1] = 0;
    Y.n[0] = 0;
    Y.n[1] = 0;
    UART_Init();
    INT_Init();
    ADC_Init();
    Timer0_8bit();
    ADC_Start_Conversion(0);
    while(1){
        if(muestras == 1){
            X.n[1] = X.n[0];// 0   5 
            X.n[0] = X.ADC;// 5  25
            temp = Coef_a0*X.n[0] + Coef_a1*X.n[1] + Coef_b1*Y.n[1];
            Y.n[1] = Y.n[0];
            Y.n[0] = (uint16_t)temp;
            UART_Tx(START_Streaming);// 03
            UART_Tx(Y.n[0]& 0x00FF); 
            UART_Tx((Y.n[0]& 0xFF00)>>8);
            UART_Tx(END_Streaming); // FE
            muestras = 0;
            __delay_ms(1);      
        }
//        if(muestras >= ARRAY_SAMPLE){
//            //Envio_Muestras();
//            //Envio_Acc();
//            //Envio_Corr_Acc();
//            //Envio_Promedio();
//            Envio_FPB();
//            muestras = 0;
//            Start_Timer0();
//        }    
    }
    return;
}
